% ------------------------------------------------------------
% amznotes - Alex M Zhang notes
% Credit to David Zhang for the original template

% To fix header for unnumbered chapters, do:
% \chapter*{Chapter Title}
% \markboth{Chapter Title}{Chapter Title}

% TODO:
%   - make math in box titles bold
%   - make macro for lower case namerefs
%   - fix big numbers messing up index
%   - maybe make index two columns?

\ProvidesPackage{amznotes}[2023/01/26 amznotes]

% ------------------------------------------------------------
% PROCESS OPTIONS

\RequirePackage{kvoptions}
\DeclareBoolOption{math}        % enables thmbox and math macros
\DeclareBoolOption{code}        % enables codebox, amzcode, and \amzinputcode
\ProcessKeyvalOptions{amznotes}

% ------------------------------------------------------------
% LOAD REQUIRED PACKAGES

\RequirePackage{fontspec}           % set main font
\RequirePackage{unicode-math}       % set math font; replaces amssymb
\RequirePackage[dvipsnames]{xcolor} % pretty colors
\RequirePackage{hyperref}           % hyperlinks in pdf viewers; will appear underlined only in pdf viewer
\RequirePackage{fancyhdr}           % fancy headers
\RequirePackage{lastpage}           % "X of Y" footer
\RequirePackage{parskip}            % new line after each paragraph w/o indent
\RequirePackage{setspace}           % 1.5 line spacing
\RequirePackage[explicit]{titlesec} % chapter styling
\RequirePackage[most]{tcolorbox}    % pretty boxes

\ifamznotes@math
    \RequirePackage{mathtools}      % for math macros; also loads amsmath
    \RequirePackage{amsthm}         % syntax coloring for code
    \renewcommand\qedsymbol{$\squoval$}
\fi

\ifamznotes@code
    \RequirePackage{minted}         % syntax coloring for code
    \tcbuselibrary{minted}
\fi

% ------------------------------------------------------------
% FONTS

\setmainfont{STIXTwoText}[
  Extension = .otf,
  UprightFont = *-Regular,
  BoldFont = *-Bold,
  ItalicFont = *-Italic,
  BoldItalicFont = *-BoldItalic,
]
\setmathfont{STIXTwoMath-Regular.otf}
\setmathfont{STIXTwoMath-Regular.otf}[range={scr,bfscr},StylisticSet=01]
\setmonofont{Inconsolata}

% ------------------------------------------------------------
% PAGE LAYOUT

\onehalfspacing

% ------------------------------------------------------------
% COLORS

\colorlet{amzchaptercolor}{RoyalBlue}
\colorlet{amzdfnboxcolor}{RoyalBlue}
\colorlet{amzthmboxcolor}{RoyalPurple}
\colorlet{amzexboxcolor}{Dandelion}
\colorlet{amzgenboxcolor}{PineGreen}
\colorlet{amztecboxcolor}{WildStrawberry}
\colorlet{amzcodeboxcolor}{darkgray}
\colorlet{amznoteboxcolor}{WildStrawberry}

% ------------------------------------------------------------
% LINKS

\hypersetup{
    colorlinks=false,
    linkbordercolor=black,
    urlbordercolor=blue,
    pdfborderstyle={/S/U/W 1}   % Underline links; only appears in pdf viewer, not printed
}

% ------------------------------------------------------------
% CHAPTER STYLING

\titleformat{\chapter}[display]{\normalfont\huge\bfseries}
{}
{20pt}
{
    \begin{tcolorbox}[
        enhanced,
        left=23mm,
        right=25mm,
        top=2mm,
        spread sidewards,
        sharp corners,
        colback=amzchaptercolor,
        colframe=amzchaptercolor,
        boxrule=1mm,
        title=\thechapter,
        attach boxed title to top right={xshift=-15mm, yshift=-4mm},
        boxed title style={
            size=small,
            colback=amzchaptercolor,
            colframe=white
        }
    ]
        \strut \textcolor{white}{#1}
    \end{tcolorbox}
}

\titleformat{name=\chapter,numberless}[display]{\normalfont\huge\bfseries}
{}
{20pt}
{
    \begin{tcolorbox}[
        enhanced,
        left=23mm,
        right=25mm,
        top=2mm,
        spread sidewards,
        sharp corners,
        colback=amzchaptercolor,
        colframe=amzchaptercolor,
        boxrule=1mm,
    ]
        \strut \textcolor{white}{#1}
    \end{tcolorbox}
}

\titlespacing*{\chapter}{0pt}{-40mm}{-15mm}

% ------------------------------------------------------------
% HEADER STYLING

\pagestyle{fancy}
\lhead{\footnotesize\nouppercase{\leftmark}}
\rhead{\footnotesize\nouppercase{\rightmark}}
\cfoot{\thepage\ of \pageref{LastPage}}

\fancypagestyle{plain}{
    \renewcommand{\headrulewidth}{0pt}
    \fancyhead{}
    \cfoot[C]{\thepage\ of \pageref{LastPage}}
}

% ------------------------------------------------------------
% COLOR BOXES

\newcommand{\amztitlesep}{\ \raisebox{2.3pt}{\scalebox{0.5}{ $\blacktriangleright$}}}

\tcbset{
    coolshadow/.style={
        drop fuzzy shadow,
    },
    amzdefaultstyle/.style={
        enhanced,
        fonttitle=\strut\bfseries,  % strut for uniform title height
        sharp corners,
        boxrule=0pt,
        frame hidden,
        segmentation style={solid,opacity=0.2,line width=1pt},
        separator sign={\amztitlesep},
        parbox=false,
        %breakable,
        coolshadow
    },
    dfnboxstyle/.style={
        amzdefaultstyle,
        frame style={fill=amzdfnboxcolor!75!black},
        interior style={fill=amzdfnboxcolor!5!white}
    },
    thmboxstyle/.style={
        amzdefaultstyle,
        frame style={fill=amzthmboxcolor!75!black},
        interior style={fill=amzthmboxcolor!5!white}
    },
    exboxstyle/.style={
        amzdefaultstyle,
        frame style={fill=amzexboxcolor!75!black},
        interior style={fill=amzexboxcolor!5!white}
    },
    genboxstyle/.style={
        amzdefaultstyle,
        frame style={fill=amzgenboxcolor!75!black},
        interior style={fill=amzgenboxcolor!5!white}
    },
    tecboxstyle/.style={
        amzdefaultstyle,
        frame style={fill=amztecboxcolor!75!black},
        interior style={fill=amztecboxcolor!5!white}
    },
    codeboxstyle/.style={
        amzdefaultstyle,
        breakable,
        frame style={fill=amzcodeboxcolor!75!black},
        interior style={fill=amzcodeboxcolor!5!white},
        overlay={\begin{tcbclipinterior}\fill[darkgray!20!white] (frame.south west) rectangle ([xshift=6mm]frame.north west);\end{tcbclipinterior}},
        skin=bicolor,
        collower=white,
        colbacklower=darkgray
    },
    noteboxstyle/.style={
        enhanced,
        boxrule=0pt,frame hidden,
        borderline west={4pt}{0pt}{WildStrawberry!75!black},
        colback=amznoteboxcolor!7!white,
        sharp corners,
    }
}

\newtcbtheorem[auto counter,number within=section,list inside={dfn}]{tcdfnbox}{Definition}{dfnboxstyle}{dfn}
\newif\ifdfnboxused

\newtcbtheorem[auto counter,number within=section,list inside={ex}]{tcexbox}{Example}{exboxstyle}{ex}
\newif\ifexboxused

\newtcbtheorem[auto counter,number within=section,list inside={tec}]{tctecbox}{Technique}{tecboxstyle}{tec}
\newif\iftecboxused

\newtcolorbox{genbox}[1]{amzdefaultstyle, genboxstyle, title={#1}}

\newtcolorbox{notebox}{noteboxstyle}

\ifamznotes@math
    \newtcbtheorem[auto counter,number within=section,list inside={thm}]{tcthmbox}{Theorem}{thmboxstyle}{thm}
\fi
\newif\ifthmboxused

\ifamznotes@code
    \renewcommand{\theFancyVerbLine}{\ttfamily\scriptsize{\arabic{FancyVerbLine}}}

    \newtcbtheorem[auto counter,number within=section,list inside={code}]{tccodebox}{Code Snippet}{codeboxstyle}{code}

    \newenvironment{amzcode}[2][]{
        \VerbatimEnvironment
        \begin{minted}[
        linenos,            % Display line numbers
        breaklines,         % Allow line breaks
        autogobble,         % Collapse extra white spaces
        xleftmargin=3.15mm,
        ]{#2}}
    {\end{minted}}

    \newcommand{\amzinputcode}[2]{\inputminted[
        linenos,            % Display line numbers
        breaklines,         % Allow line breaks
        autogobble,         % Collapse extra white spaces
        xleftmargin=3.15mm,
    ]{#1}{#2}}
\fi
\newif\ifcodeboxused

% ------------------------------------------------------------
% COLOR BOX ENVIRONMENTS & COMMANDS

\newenvironment{dfnbox}[2]{
    \global\dfnboxusedtrue
    \begin{tcdfnbox}{#1}{#2}
}{
    \end{tcdfnbox}
}

\newenvironment{dfnbox*}[1]{
    \begin{tcdfnbox*}{#1}
}{
    \end{tcdfnbox*}
}

\newenvironment{exbox}[2]{
    \global\exboxusedtrue
    \begin{tcexbox}{#1}{#2}
}{
    \end{tcexbox}
}

\newenvironment{exbox*}[1]{
    \begin{tcexbox*}{#1}
}{
    \end{tcexbox*}
}

\newenvironment{tecbox}[2]{
    \global\tecboxusedtrue
    \begin{tctecbox}{#1}{#2}
}{
    \end{tctecbox}
}

\newenvironment{tecbox*}[1]{
    \begin{tctecbox*}{#1}
}{
    \end{tctecbox*}
}

\ifamznotes@math
    \newenvironment{thmbox}[2]{
        \global\thmboxusedtrue
        \begin{tcthmbox}{#1}{#2}
    }{
        \end{tcthmbox}
    }


    \newenvironment{thmbox*}[1]{
        \begin{tcthmbox*}{#1}
    }{
        \end{tcthmbox*}
    }
\fi

\ifamznotes@code
    \newenvironment{codebox}[2]{
        \global\codeboxusedtrue
        \begin{tccodebox}{#1}{#2}
    }{
        \end{tccodebox}
    }

    \newenvironment{codebox*}[1]{
        \begin{tccodebox*}{#1}
    }{
        \end{tccodebox*}
    }
\fi

\newcommand{\amzindex}{
    \addcontentsline{toc}{chapter}{Index}
    \chapter*{Index}

    % Remove header for index
    \renewcommand{\headrulewidth}{0pt}
    \fancyhead{}

    % Add references
    \ifdfnboxused
        \tcblistof[\section*]{dfn}{Definitions}
    \fi
    \ifexboxused
        \tcblistof[\section*]{ex}{Examples}
    \fi
    \iftecboxused
        \tcblistof[\section*]{tec}{Techniques}
    \fi
    \ifthmboxused
        \tcblistof[\section*]{thm}{Theorems}
    \fi
    \ifcodeboxused
        \tcblistof[\section*]{code}{Code Snippets}
    \fi
}

% ------------------------------------------------------------
% TEXT MACROS

\newcommand{\dfntxt}[1]{{\textbf{#1}}}

% ------------------------------------------------------------
% MATH MACROS

\ifamznotes@math
    \newcommand{\rel}[1]{\mathrel{\mathcal{#1}}}

    \newcommand{\N}{\mathbb{N}}
    \newcommand{\Z}{\mathbb{Z}}
    \newcommand{\Q}{\mathbb{Q}}
    \newcommand{\R}{\mathbb{R}}
    \newcommand{\C}{\mathbb{C}}
    \newcommand{\F}{\mathbb{F}}

    \newcommand{\id}{\text{id}}
    \newcommand{\bigO}{\mathcal{O}}
    \DeclareMathOperator{\laplace}{\mathscr{L}}
    \newcommand{\symdiff}{\bigtriangleup}

    \DeclarePairedDelimiter\abs{\lvert}{\rvert}
    \DeclarePairedDelimiter\ceil{\lceil}{\rceil}
    \DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

    % Function Restriction
    % From https://tex.stackexchange.com/a/22255
    \newcommand\restrict[2]{{
        \left.\kern-\nulldelimiterspace
        #1
        \vphantom{\big|}
        \right|_{#2}
    }}
\fi
